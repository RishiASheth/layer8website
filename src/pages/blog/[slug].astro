---
import Layout from "../../layouts/Layout.astro";
import { readdir, readFile } from "fs/promises";
import { join } from "path";

export async function getStaticPaths() {
  const blogDir = join(process.cwd(), "src/content/blog");
  let blogFiles = [];
  try {
    blogFiles = await readdir(blogDir);
  } catch {
    return [];
  }

  return blogFiles
    .filter((file) => file.endsWith(".md"))
    .map((file) => ({
      params: { slug: file.replace(".md", "") },
    }));
}

const { slug } = Astro.params;
const blogDir = join(process.cwd(), "src/content/blog");
const content = await readFile(join(blogDir, `${slug}.md`), "utf-8");

// Frontmatter
const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
const frontmatter: any = {};

if (frontmatterMatch) {
  const frontmatterText = frontmatterMatch[1];
  frontmatterText.split("\n").forEach((line) => {
    const [key, ...valueParts] = line.split(":");
    if (key && valueParts.length) {
      frontmatter[key.trim()] = valueParts
        .join(":")
        .trim()
        .replace(/['"]/g, "");
    }
  });
}

// Markdown → HTML
const markdownContent = content.replace(/^---\n[\s\S]*?\n---\n/, "");

let htmlContent = markdownContent
  .replace(/^# (.*$)/gim, "<h1>$1</h1>")
  .replace(/^## (.*$)/gim, "<h2>$1</h2>")
  .replace(/^### (.*$)/gim, "<h3>$1</h3>")
  .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
  .replace(/\*(.*?)\*/g, "<em>$1</em>")
  .replace(/```([\s\S]*?)```/g, "<pre><code>$1</code></pre>")
  .replace(/`(.*?)`/g, "<code>$1</code>")
  .replace(/^- (.*$)/gim, "<li>$1</li>")
  .replace(/\n\n/g, "</p><p>")
  .replace(/^(?!<[hl]|<li|<pre)/gim, "<p>")
  .replace(/$(?!<\/[hl]|<\/li>|<\/pre>)/gim, "</p>");

htmlContent = htmlContent.replace(/(<li>.*?<\/li>)/gis, "<ul>$1</ul>");
---

<Layout title={frontmatter.title}>
  <article class="blog-post">
    <a href="/blog" class="back-link">← Return to Logs</a>

    <header class="post-header">
      <h1>{frontmatter.title}</h1>

      <div class="post-meta">
        <span>✍ {frontmatter.author}</span>
        <span>•</span>
        <span>
          {
            new Date(frontmatter.date).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </span>
      </div>
    </header>

    <section class="post-content" set:html={htmlContent} />
  </article>
</Layout>

<style>
  /* ---------- CONTAINER ---------- */
  .blog-post {
    max-width: 900px;
    margin: auto;
    padding: 3.2rem;
    background: rgba(15, 18, 35, 0.85);
    border-radius: 26px;
    border: 1px solid rgba(127, 124, 255, 0.35);
    backdrop-filter: blur(18px);
    box-shadow:
      inset 0 0 30px rgba(127, 124, 255, 0.1),
      0 30px 60px rgba(0, 0, 0, 0.5);
  }

  /* ---------- BACK LINK ---------- */
  .back-link {
    display: inline-block;
    margin-bottom: 2.6rem;
    color: #00ffe0;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-decoration: none;
  }

  .back-link:hover {
    text-shadow: 0 0 12px rgba(0, 255, 224, 0.9);
  }

  /* ---------- HEADER ---------- */
  .post-header {
    margin-bottom: 3rem;
  }

  .post-header h1 {
    font-size: clamp(2.6rem, 5vw, 3.4rem);
    letter-spacing: 0.1em;
    margin-bottom: 1.2rem;
    background: linear-gradient(135deg, #7f7cff, #00ffe0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow:
      0 0 25px rgba(127, 124, 255, 0.6),
      0 0 50px rgba(0, 255, 224, 0.35);
  }

  /* ---------- META ---------- */
  .post-meta {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    font-size: 0.95rem;
    color: #9aa2ff;
  }

  /* ---------- CONTENT ---------- */
  .post-content {
    line-height: 1.9;
    color: #e6e9ff;
  }

  .post-content :global(h1),
  .post-content :global(h2),
  .post-content :global(h3) {
    margin-top: 2.6rem;
    margin-bottom: 1rem;
    color: #00ffe0;
  }

  .post-content :global(h1) {
    font-size: 2rem;
  }
  .post-content :global(h2) {
    font-size: 1.6rem;
  }
  .post-content :global(h3) {
    font-size: 1.3rem;
  }

  .post-content :global(p) {
    margin-bottom: 1.3rem;
    color: #9aa2ff;
  }

  .post-content :global(ul) {
    margin: 1.2rem 0 1.6rem 2rem;
  }

  .post-content :global(li) {
    margin: 0.6rem 0;
  }

  /* ---------- INLINE CODE ---------- */
  .post-content :global(code) {
    background: rgba(0, 255, 224, 0.12);
    padding: 0.25rem 0.45rem;
    border-radius: 6px;
    font-family: monospace;
    font-size: 0.9em;
    color: #00ffe0;
  }

  /* ---------- CODE BLOCK ---------- */
  .post-content :global(pre) {
    background: #05060f;
    border-radius: 14px;
    border: 1px solid rgba(127, 124, 255, 0.35);
    padding: 1.6rem;
    overflow-x: auto;
    margin: 2rem 0;
    box-shadow: 0 0 30px rgba(127, 124, 255, 0.35);
  }

  .post-content :global(pre code) {
    background: transparent;
    padding: 0;
    color: #e6e9ff;
    font-size: 0.95rem;
  }

  /* ---------- EMPHASIS ---------- */
  .post-content :global(strong) {
    color: #e6e9ff;
  }

  .post-content :global(em) {
    color: #7f7cff;
  }
</style>
